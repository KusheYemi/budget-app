generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id           String        @id @default(uuid())
  email        String        @unique
  currency     String        @default("SLE") // SLE (Sierra Leone Leones), USD, GBP, EUR, etc.
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  budgetMonths BudgetMonth[]
  categories   Category[]

  @@map("users")
}

model BudgetMonth {
  id               String       @id @default(uuid())
  userId           String       @map("user_id")
  year             Int
  month            Int          // 1-12
  income           Decimal      @db.Decimal(12, 2)
  savingsRate      Float        @default(0.20) @map("savings_rate")
  adjustmentReason String?      @map("adjustment_reason") // Required when savingsRate < 0.20
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  allocations      Allocation[]

  @@unique([userId, year, month])
  @@index([userId])
  @@map("budget_months")
}

model Category {
  id          String       @id @default(uuid())
  userId      String       @map("user_id")
  name        String
  color       String       @default("#6366f1")
  isSavings   Boolean      @default(false) @map("is_savings")
  isDefault   Boolean      @default(false) @map("is_default")
  sortOrder   Int          @default(0) @map("sort_order")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  allocations Allocation[]

  @@unique([userId, name])
  @@index([userId])
  @@map("categories")
}

model Allocation {
  id            String      @id @default(uuid())
  budgetMonthId String      @map("budget_month_id")
  categoryId    String      @map("category_id")
  amount        Decimal     @db.Decimal(12, 2)
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  budgetMonth   BudgetMonth @relation(fields: [budgetMonthId], references: [id], onDelete: Cascade)
  category      Category    @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([budgetMonthId, categoryId])
  @@index([budgetMonthId])
  @@index([categoryId])
  @@map("allocations")
}
